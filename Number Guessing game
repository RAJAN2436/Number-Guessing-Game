#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <string.h>

#ifdef _WIN32
#include <windows.h>
#endif

/* ANSI color codes (will be ignored in terminals that don't support them) */
#define C_RESET  "\x1b[0m"
#define C_RED    "\x1b[31m"
#define C_GREEN  "\x1b[32m"
#define C_YELLOW "\x1b[33m"
#define C_CYAN   "\x1b[36m"
#define C_MAG    "\x1b[35m"
#define C_BOLD   "\x1b[1m"

void enable_virtual_terminal_on_windows() {
#ifdef _WIN32
    /* Enable ANSI escape sequences on Windows 10+ consoles */
    HANDLE hOut = GetStdHandle(STD_OUTPUT_HANDLE);
    if (hOut == INVALID_HANDLE_VALUE) return;
    DWORD dwMode = 0;
    if (!GetConsoleMode(hOut, &dwMode)) return;
    dwMode |= 0x0004; /* ENABLE_VIRTUAL_TERMINAL_PROCESSING */
    SetConsoleMode(hOut, dwMode);
#endif
}

void clear_input_buffer() {
    int c;
    while ((c = getchar()) != '\n' && c != EOF) { }
}

void print_title() {
    printf(C_CYAN C_BOLD "\n=== NUMBER GUESSING GAME ===\n" C_RESET);
}

void show_instructions() {
    printf(C_YELLOW "\nInstructions:\n" C_RESET);
    printf(" - Choose a difficulty. The computer picks a random number in the chosen range.\n");
    printf(" - You have a limited number of attempts to guess it.\n");
    printf(" - After each guess you'll be told if your guess is too high or too low.\n");
    printf(" - Score is awarded based on difficulty and remaining attempts.\n\n");
}

int choose_difficulty(int *max_number, int *max_attempts, const char *choice_str) {
    int choice = 0;
    if (choice_str != NULL) {
        /* try to parse numeric string (for safer flows); not used here */
        choice = atoi(choice_str);
    }

    printf(C_MAG "Choose difficulty:\n" C_RESET);
    printf(" 1) Easy   (range 1-50, 10 attempts)\n");
    printf(" 2) Medium (range 1-100, 7 attempts)\n");
    printf(" 3) Hard   (range 1-200, 5 attempts)\n");
    printf("Select (1-3): ");

    if (scanf("%d", &choice) != 1) {
        clear_input_buffer();
        return -1;
    }

    switch (choice) {
        case 1: *max_number = 50;  *max_attempts = 10; return 1;
        case 2: *max_number = 100; *max_attempts = 7;  return 2;
        case 3: *max_number = 200; *max_attempts = 5;  return 3;
        default: return -1;
    }
}

int calculate_score(int difficulty_level, int attempts_left) {
    /* Basic scoring: base points per difficulty + bonus for remaining attempts */
    int base = 0;
    if (difficulty_level == 1) base = 50;    // Easy
    if (difficulty_level == 2) base = 100;   // Medium
    if (difficulty_level == 3) base = 200;   // Hard
    return base + (attempts_left * 10);
}

void play_game(int *high_score) {
    int max_number = 100, max_attempts = 7;
    int difficulty = 2;

    while (1) {
        difficulty = choose_difficulty(&max_number, &max_attempts, NULL);
        if (difficulty == -1) {
            printf(C_RED "Invalid choice. Please enter 1, 2 or 3.\n" C_RESET);
            continue;
        }
        break;
    }

    srand((unsigned int)time(NULL));
    int secret = (rand() % max_number) + 1;
    int attempts = 0;
    int guess = 0;
    int attempts_left = max_attempts;
    int won = 0;

    printf(C_CYAN "\nI have picked a number between 1 and %d. You have %d attempts.\n" C_RESET,
           max_number, max_attempts);

    while (attempts < max_attempts) {
        attempts++;
        attempts_left = max_attempts - attempts;

        printf("\nAttempt %d of %d â€” Enter your guess: ", attempts, max_attempts);
        if (scanf("%d", &guess) != 1) {
            clear_input_buffer();
            printf(C_RED "Invalid input. Please enter a whole number.\n" C_RESET);
            attempts--; /* don't count invalid input as an attempt */
            continue;
        }

        if (guess < 1 || guess > max_number) {
            printf(C_YELLOW "Please guess within the range 1 to %d.\n" C_RESET, max_number);
            continue; /* don't penalize for out-of-range */
        }

        if (guess > secret) {
            printf(C_RED "Too high!%s\n" C_RESET, attempts_left > 0 ? " Try again." : "");
        } else if (guess < secret) {
            printf(C_RED "Too low!%s\n" C_RESET, attempts_left > 0 ? " Try again." : "");
        } else {
            printf(C_GREEN C_BOLD "\nðŸŽ‰ Correct! You guessed the number %d in %d attempt(s).\n" C_RESET,
                   secret, attempts);
            won = 1;
            break;
        }
    }

    if (!won) {
        printf(C_RED C_BOLD "\nâ˜¹ï¸ You've used all attempts. The number was %d.\n" C_RESET, secret);
    }

    int score = 0;
    if (won) {
        score = calculate_score(difficulty, attempts_left);
        printf(C_GREEN "Score for this round: %d\n" C_RESET, score);
        if (score > *high_score) {
            *high_score = score;
            printf(C_CYAN C_BOLD "New high score! %d\n" C_RESET, *high_score);
        }
    } else {
        printf(C_YELLOW "No score awarded. Try again to earn points.\n" C_RESET);
    }
}

int main(void) {
    enable_virtual_terminal_on_windows();
    int running = 1;
    int high_score = 0;
    int menu_choice = 0;

    print_title();

    while (running) {
        printf("\n" C_BOLD "Main Menu:\n" C_RESET);
        printf(" 1) Play Game\n");
        printf(" 2) Instructions\n");
        printf(" 3) Show High Score\n");
        printf(" 4) Exit\n");
        printf("Select an option (1-4): ");

        if (scanf("%d", &menu_choice) != 1) {
            clear_input_buffer();
            printf(C_RED "Invalid input. Please enter a number between 1 and 4.\n" C_RESET);
            continue;
        }

        switch (menu_choice) {
            case 1:
                play_game(&high_score);
                break;
            case 2:
                show_instructions();
                break;
            case 3:
                if (high_score > 0)
                    printf(C_CYAN "Session high score: %d\n" C_RESET, high_score);
                else
                    printf(C_YELLOW "No high score yet. Play to set one!\n" C_RESET);
                break;
            case 4:
                printf(C_MAG "Thanks for playing â€” Goodbye!\n" C_RESET);
                running = 0;
                break;
            default:
                printf(C_RED "Please select a valid option (1-4).\n" C_RESET);
        }
    }

    return 0;
}
